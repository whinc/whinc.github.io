"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[6853],{7978:(e,t,n)=>{n.d(t,{Z:()=>l});var r=n(3945),s=n(7294);const a={},o=(e,t)=>{const[n,r]=(0,s.useState)(e?"loading":"unset"),o=(0,s.useRef)();return(0,s.useEffect)((()=>{if(!e)return void r("unset");const n=e.replace(/[|#].*$/,"");if("css"===(null==t?void 0:t.type)||!(null==t?void 0:t.type)&&/(^css!|\.css$)/.test(n)){const n=((e,t={})=>{const n=document.querySelector(`link[href="${e}"]`);if(!n){const n=document.createElement("link");return n.rel="stylesheet",n.href=e,Object.keys(t).forEach((e=>{n[e]=t[e]})),"hideFocus"in n&&n.relList&&(n.rel="preload",n.as="style"),n.setAttribute("data-status","loading"),document.head.appendChild(n),{ref:n,status:"loading"}}return{ref:n,status:n.getAttribute("data-status")||"ready"}})(e,null==t?void 0:t.css);o.current=n.ref,r(n.status)}else if("js"===(null==t?void 0:t.type)||!(null==t?void 0:t.type)&&/(^js!|\.js$)/.test(n)){const n=((e,t={})=>{const n=document.querySelector(`script[src="${e}"]`);if(!n){const n=document.createElement("script");return n.src=e,Object.keys(t).forEach((e=>{n[e]=t[e]})),n.setAttribute("data-status","loading"),document.body.appendChild(n),{ref:n,status:"loading"}}return{ref:n,status:n.getAttribute("data-status")||"ready"}})(e,null==t?void 0:t.js);o.current=n.ref,r(n.status)}else console.error("Cannot infer the type of external resource, and please provide a type ('js' | 'css'). Refer to the https://ahooks.js.org/hooks/dom/use-external/#options");if(!o.current)return;void 0===a[e]?a[e]=1:a[e]+=1;const s=e=>{var t;const n="load"===e.type?"ready":"error";null===(t=o.current)||void 0===t||t.setAttribute("data-status",n),r(n)};return o.current.addEventListener("load",s),o.current.addEventListener("error",s),()=>{var t,n,r;null===(t=o.current)||void 0===t||t.removeEventListener("load",s),null===(n=o.current)||void 0===n||n.removeEventListener("error",s),a[e]-=1,0===a[e]&&(null===(r=o.current)||void 0===r||r.remove()),o.current=void 0}}),[e]),n};function l(e){let{source:t,...n}=e;const[a,l]=(0,s.useState)(!1),i=o("/js/runkit.js",{js:{async:!0}}),d=(0,s.useRef)(null);return(0,s.useEffect)((()=>{if("ready"===i&&window.RunKit&&d.current){l(!0);window.RunKit.createNotebook({element:d.current,nodeVersion:"18.x.x",source:t.trim(),...n}).onLoad=()=>l(!1)}}),[i]),s.createElement(s.Fragment,null,("ready"!==i||a)&&s.createElement(r.Z,{language:"javascript"},t.trim()),s.createElement("div",{ref:d}),!1)}},3945:(e,t,n)=>{n.d(t,{Z:()=>a});var r=n(7294),s=n(814);function a(e){return r.createElement(r.Fragment,null,r.createElement(s.Z,e))}},1227:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>i,default:()=>b,frontMatter:()=>l,metadata:()=>d,toc:()=>c});var r=n(7462),s=(n(7294),n(3905)),a=n(7978),o=n(3361);const l={tags:["Node.js","ORM"],keywords:["knex","orm","query builder"]},i="Knex.js \u6559\u7a0b",d={permalink:"/blog/2023/04/05/knex-tutorial",editUrl:"https://github.com/whinc/whinc.github.io/tree/master/website/blog/2023/04-05-knex-tutorial/index.mdx",source:"@site/blog/2023/04-05-knex-tutorial/index.mdx",title:"Knex.js \u6559\u7a0b",description:"\u4ec0\u4e48\u662f Knex \uff1f",date:"2023-04-05T00:00:00.000Z",formattedDate:"April 5, 2023",tags:[{label:"Node.js",permalink:"/blog/tags/node-js"},{label:"ORM",permalink:"/blog/tags/orm"}],readingTime:3.035,hasTruncateMarker:!0,authors:[],frontMatter:{tags:["Node.js","ORM"],keywords:["knex","orm","query builder"]},nextItem:{title:"Antd \u5f39\u7a97\u5c01\u88c5",permalink:"/blog/2023/03/04/antd-create-modal"}},u={authorsImageUrls:[]},c=[{value:"\u4ec0\u4e48\u662f Knex \uff1f",id:"\u4ec0\u4e48\u662f-knex-",level:2},{value:"\u4f18\u70b9\u53ca\u5e94\u7528\u573a\u666f",id:"\u4f18\u70b9\u53ca\u5e94\u7528\u573a\u666f",level:2},{value:"CRUD \u793a\u4f8b",id:"crud-\u793a\u4f8b",level:2},{value:"\u5b9a\u4e49\u8868\u7ed3\u6784",id:"\u5b9a\u4e49\u8868\u7ed3\u6784",level:3},{value:"Create \u63d2\u5165",id:"create-\u63d2\u5165",level:3},{value:"Read \u67e5\u8be2",id:"read-\u67e5\u8be2",level:3},{value:"Update \u66f4\u65b0",id:"update-\u66f4\u65b0",level:3},{value:"Delete \u5220\u9664",id:"delete-\u5220\u9664",level:3},{value:"\u5206\u9875\u67e5\u8be2",id:"\u5206\u9875\u67e5\u8be2",level:3},{value:"\u8fde\u8868\u67e5\u8be2",id:"\u8fde\u8868\u67e5\u8be2",level:3},{value:"\u4e8b\u52a1",id:"\u4e8b\u52a1",level:3},{value:"\u6570\u636e\u8fc1\u79fb",id:"\u6570\u636e\u8fc1\u79fb",level:2},{value:"\u79cd\u5b50\u6570\u636e",id:"\u79cd\u5b50\u6570\u636e",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}],m={toc:c},p="wrapper";function b(e){let{components:t,...n}=e;return(0,s.kt)(p,(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h2",{id:"\u4ec0\u4e48\u662f-knex-"},"\u4ec0\u4e48\u662f Knex \uff1f"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://github.com/knex/knex"},"Knex")," \u662f\u4e00\u4e2a\u4f7f\u7528 javascript \u5b9e\u73b0\u7684\u8de8\u6570\u636e\u5e93\u7684 SQL Query Builder\uff0c\u57fa\u4e8e javascript \u5b9e\u73b0\u4e86\u4e00\u5957\u7075\u6d3b\u3001\u53ef\u79fb\u690d\u3001\u6613\u4e8e\u4f7f\u7528 SQL DSL\uff0c\u652f\u6301\u7684\u6570\u636e\u5e93\u6709 PostgreSQL, MySQL, CockroachDB, SQL Server, SQLite3 \u548c Oracle\uff0c\u652f\u6301\u4e8b\u52a1\u3001\u6570\u636e\u8fc1\u79fb\u7b49\uff0c\u540c\u65f6\u652f\u6301 Node.js \u548c\u6d4f\u89c8\u5668\u3002"),(0,s.kt)("p",null,"\u4e0b\u9762\u662f Knex \u7684\u4f7f\u7528\u793a\u4f8b\uff0c\u4f7f\u7528 js \u5b9e\u73b0\u7684 DSL \u8bfb\u5199\u4e0a\u4e0e SQL \u975e\u5e38\u76f8\u4f3c\u3002"),(0,s.kt)(a.Z,{evaluateOnLoad:!0,source:`\n${o.Z}\np(db.table('aa').select('b', 'c'))\n`,mdxType:"RunKitEmbed"}),(0,s.kt)("h2",{id:"\u4f18\u70b9\u53ca\u5e94\u7528\u573a\u666f"},"\u4f18\u70b9\u53ca\u5e94\u7528\u573a\u666f"),(0,s.kt)("p",null,"\u7531\u4e8e Node.js \u6ca1\u6709\u63d0\u4f9b\u50cf java \u4e2d\u7684 JDBC \u8fd9\u6837\u7684\u6570\u636e\u5e93\u8bbf\u95ee\u62bd\u8c61\u5c42\uff0c\u5bfc\u81f4\u57fa\u4e8e\u539f\u751f\u7684 Node.js \u8fdb\u884c\u6570\u636e\u5e93\u7f16\u7a0b\u65f6\uff0c\u9700\u8981\u9762\u5411\u4e0d\u540c\u7684\u6570\u636e\u5e93\u7c7b\u578b\u63d0\u4f9b\u7684\u5e95\u5c42 SDK \u7f16\u7a0b\uff0c\u5b66\u4e60\u6210\u672c\u9ad8\u3001\u4e0d\u53ef\u79fb\u690d\u3002"),(0,s.kt)("p",null,'Knex \u5efa\u7acb\u5728\u5e95\u5c42\u6570\u636e\u5e93\u63d0\u4f9b\u7684 SDK \u4e4b\u4e0a\uff0c\u63d0\u4f9b\u7edf\u4e00\u7684 API \u6570\u636e\u5e93\u63a5\u53e3\uff0c\u53ef\u4ee5\u5c06\u5176\u770b\u6210\u662f Node.js \u4e2d\u7c7b\u4f3c"JDBC"\u7684\u5b58\u5728\uff0c\u4ee3\u7801\u4e0e\u5e95\u5c42\u6570\u636e\u5e93\u8026\u5408\u5f31\uff0c\u65b9\u4fbf\u5728\u6570\u636e\u5e93\u4e4b\u95f4\u8fc1\u79fb\uff08\u5982\u672c\u5730\u5f00\u53d1\u6d4b\u8bd5\u7528 sqlite3\uff0c\u7ebf\u4e0a\u7528MySQL\uff09\uff0c\u65e0\u9700\u5b66\u4e60 SQL \u65b9\u8a00\u3002'),(0,s.kt)("mermaid",{value:"flowchart TD\n    A[Web Server] --\x3e|DSL based on javascript| B(Knex)\n    B --\x3e MySQL\n    B --\x3e PostgreSQL\n    B --\x3e |native sql| SQLite3\n    B --\x3e SQLServer[SQL Server]\n    B --\x3e Oracle"}),(0,s.kt)("h2",{id:"crud-\u793a\u4f8b"},"CRUD \u793a\u4f8b"),(0,s.kt)("p",null,"\u4e0b\u9762\u793a\u4f8b\u6f14\u793a\u57fa\u4e8e Knex \u5b9e\u73b0\u5e38\u89c1\u7684 CRUD \u64cd\u4f5c\uff0c\u6267\u884c\u7ed3\u679c\u901a\u8fc7\u6700\u7ec8\u751f\u6210\u7684 SQL \u8868\u793a\u3002"),(0,s.kt)("h3",{id:"\u5b9a\u4e49\u8868\u7ed3\u6784"},"\u5b9a\u4e49\u8868\u7ed3\u6784"),(0,s.kt)(a.Z,{source:"\np(db.schema.createTable('users', function (table) {\n  table.increments('id');\n  table.string('name');\n  table.integer('age');\n  table.timestamps('create_at');\n}))\n",preamble:o.Z,mdxType:"RunKitEmbed"}),(0,s.kt)("h3",{id:"create-\u63d2\u5165"},"Create \u63d2\u5165"),(0,s.kt)(a.Z,{source:"\np(db.table('users').insert({name: 'whincwu', age: 32}))\n",preamble:o.Z,mdxType:"RunKitEmbed"}),(0,s.kt)("h3",{id:"read-\u67e5\u8be2"},"Read \u67e5\u8be2"),(0,s.kt)(a.Z,{source:"\n// \u67e5\u8be2\u5168\u90e8\u5217\np(db.select().from('users'))\n// \u67e5\u8be2\u90e8\u5206\u5217 + \u7b5b\u9009\u6761\u4ef6 + \u6392\u5e8f\np(db.select(['name', 'age'])\n    .from('users')\n    .where('name', 'whincwu').andWhere('age', '>', 18)\n    .orderBy('age', 'desc')\n)\n// \u6a21\u7cca\u67e5\u8be2\np(db.select(['name', 'age'])\n    .from('users')\n    .whereLike('name', 'w%')\n)\n",preamble:o.Z,mdxType:"RunKitEmbed"}),(0,s.kt)("h3",{id:"update-\u66f4\u65b0"},"Update \u66f4\u65b0"),(0,s.kt)(a.Z,{source:"\n// \u6309\u6761\u4ef6\u66f4\u65b0\np(db.table('users').update({age: 33}).where('name', 'whincwu'))\n",preamble:o.Z,mdxType:"RunKitEmbed"}),(0,s.kt)("h3",{id:"delete-\u5220\u9664"},"Delete \u5220\u9664"),(0,s.kt)(a.Z,{source:"\n// \u6309\u6761\u4ef6\u5220\u9664\np(db.table('users').delete().where('id', '1'))\n",preamble:o.Z,mdxType:"RunKitEmbed"}),(0,s.kt)("h3",{id:"\u5206\u9875\u67e5\u8be2"},"\u5206\u9875\u67e5\u8be2"),(0,s.kt)(a.Z,{source:"\np(db.select('*').from('users').limit(10).offset(30))\n",preamble:o.Z,mdxType:"RunKitEmbed"}),(0,s.kt)("h3",{id:"\u8fde\u8868\u67e5\u8be2"},"\u8fde\u8868\u67e5\u8be2"),(0,s.kt)(a.Z,{source:"p(db.table('users')\n  .join('contacts', 'users.id', '=', 'contacts.user_id')\n  .select('users.id', 'contacts.phone'));\n// \u591a\u4e2a join \u6761\u4ef6\np(db.select('*').from('users').join('accounts', function() {\n  this\n    .on('accounts.id', '=', 'users.account_id')\n    .orOn('accounts.owner_id', '=', 'users.id')\n}));",preamble:o.Z,mdxType:"RunKitEmbed"}),(0,s.kt)("h3",{id:"\u4e8b\u52a1"},"\u4e8b\u52a1"),(0,s.kt)(a.Z,{readOnly:!0,source:"db.transaction(function(trx) {\n  const books = [\n    {title: 'Canterbury Tales'},\n    {title: 'Moby Dick'},\n    {title: 'Hamlet'}\n  ];\n  return trx\n    .insert({name: 'Old Books'}, 'id')\n    .into('catalogues')\n    .then(function(ids) {\n      books.forEach((book) => book.catalogue_id = ids[0]);\n      return trx('books').insert(books);\n    })\n})\n.then(function(inserts) {\n    // \u4e8b\u52a1\u6267\u884c\u6210\u529f\n    console.log(inserts.length + ' new books saved.');\n})\n.catch(function(error) {\n    // \u4e8b\u52a1\u6267\u884c\u5931\u8d25\uff0c\u81ea\u52a8\u56de\u6eda\n    // If we get here, that means that \n    // neither the 'Old Books' catalogues insert,\n    // nor any of the books inserts will have taken place.\n    console.error(error);\n});\n",preamble:o.Z,mdxType:"RunKitEmbed"}),(0,s.kt)("h2",{id:"\u6570\u636e\u8fc1\u79fb"},"\u6570\u636e\u8fc1\u79fb"),(0,s.kt)("h3",{id:"\u79cd\u5b50\u6570\u636e"},"\u79cd\u5b50\u6570\u636e"),(0,s.kt)("h2",{id:"\u603b\u7ed3"},"\u603b\u7ed3"))}b.isMDXComponent=!0},3361:(e,t,n)=>{n.d(t,{Z:()=>r});const r="const knex = require('knex');\nconst db = knex({ client: 'mysql' });\nconst p = (builder) => {\n    const sql = builder.toSQL()\n    console.log(sql.toNative ? sql.toNative() : sql)\n}"}}]);